{"ast":null,"code":"\"use strict\";\n\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nfunction _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\n\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  return Constructor;\n}\n/*\n * Updates-Via\n */\n\n\nvar namedNode = require('./data-factory').namedNode;\n\nvar UpdatesSocket =\n/*#__PURE__*/\nfunction () {\n  function UpdatesSocket(parent, via) {\n    _classCallCheck(this, UpdatesSocket);\n\n    this.parent = parent;\n    this.via = via;\n    this.connected = false;\n    this.pending = {};\n    this.subscribed = {};\n    this.socket = {};\n\n    try {\n      this.socket = new WebSocket(via);\n      this.socket.onopen = this.onOpen;\n      this.socket.onclose = this.onClose;\n      this.socket.onmessage = this.onMessage;\n      this.socket.onerror = this.onError;\n    } catch (error) {\n      this.onError(error);\n    }\n  }\n\n  _createClass(UpdatesSocket, [{\n    key: \"_decode\",\n    value: function _decode(q) {\n      var elt;\n      var i;\n      var k;\n      var r;\n      var ref;\n      var ref1;\n      var v;\n      r = {};\n\n      ref = function () {\n        var j, len, ref, results;\n        ref = q.split('&');\n        results = [];\n\n        for (j = 0, len = ref.length; j < len; j++) {\n          elt = ref[j];\n          results.push(elt.split('='));\n        }\n\n        return results;\n      }();\n\n      for (i in ref) {\n        elt = ref[i];\n        ref1 = [decodeURIComponent(elt[0]), decodeURIComponent(elt[1])];\n        k = ref1[0];\n        v = ref1[1];\n\n        if (r[k] == null) {\n          r[k] = [];\n        }\n\n        r[k].push(v);\n      }\n\n      return r;\n    }\n  }, {\n    key: \"_send\",\n    value: function _send(method, uri, data) {\n      var base, message;\n      message = [method, uri, data].join(' ');\n      return typeof (base = this.socket).send === 'function' ? base.send(message) : void 0;\n    }\n  }, {\n    key: \"_subscribe\",\n    value: function _subscribe(uri) {\n      this._send('sub', uri, '');\n\n      this.subscribed[uri] = true;\n      return this.subscribed[uri];\n    }\n  }, {\n    key: \"onClose\",\n    value: function onClose(e) {\n      var uri;\n      this.connected = false;\n\n      for (uri in this.subscribed) {\n        this.pending[uri] = true;\n      }\n\n      this.subscribed = {};\n      return this.subscribed;\n    }\n  }, {\n    key: \"onError\",\n    value: function onError(e) {\n      throw new Error('onError' + e);\n    }\n  }, {\n    key: \"onMessage\",\n    value: function onMessage(e) {\n      var base, message;\n      message = e.data.split(' ');\n\n      if (message[0] === 'ping') {\n        return typeof (base = this.socket).send === 'function' ? base.send('pong ' + message.slice(1).join(' ')) : void 0;\n      } else if (message[0] === 'pub') {\n        return this.parent.onUpdate(message[1], this._decode(message[2]));\n      }\n    }\n  }, {\n    key: \"onOpen\",\n    value: function onOpen(e) {\n      var results, uri;\n      this.connected = true;\n      results = [];\n\n      for (uri in this.pending) {\n        delete this.pending[uri];\n        results.push(this._subscribe(uri));\n      }\n\n      return results;\n    }\n  }, {\n    key: \"subscribe\",\n    value: function subscribe(uri) {\n      if (this.connected) {\n        return this._subscribe(uri);\n      } else {\n        this.pending[uri] = true;\n        return this.pending[uri];\n      }\n    }\n  }]);\n\n  return UpdatesSocket;\n}();\n\nvar UpdatesVia =\n/*#__PURE__*/\nfunction () {\n  function UpdatesVia(fetcher) {\n    _classCallCheck(this, UpdatesVia);\n\n    this.fetcher = fetcher;\n    this.graph = {};\n    this.via = {};\n    this.fetcher.addCallback('headers', this.onHeaders);\n  }\n\n  _createClass(UpdatesVia, [{\n    key: \"onHeaders\",\n    value: function onHeaders(d) {\n      var etag, uri, via;\n\n      if (d.headers == null) {\n        return true;\n      }\n\n      if (typeof WebSocket === 'undefined' || WebSocket === null) {\n        return true;\n      }\n\n      etag = d.headers['etag'];\n      via = d.headers['updates-via'];\n      uri = d.uri;\n\n      if (etag && via) {\n        this.graph[uri] = {\n          etag: etag,\n          via: via\n        };\n        this.register(via, uri);\n      }\n\n      return true;\n    }\n  }, {\n    key: \"onUpdate\",\n    value: function onUpdate(uri, d) {\n      return this.fetcher.refresh(namedNode(uri));\n    }\n  }, {\n    key: \"register\",\n    value: function register(via, uri) {\n      if (this.via[via] == null) {\n        this.via[via] = new UpdatesSocket(this, via);\n      }\n\n      return this.via[via].subscribe(uri);\n    }\n  }]);\n\n  return UpdatesVia;\n}();\n\nmodule.exports.UpdatesSocket = UpdatesSocket;\nmodule.exports.UpdatesVia = UpdatesVia;","map":null,"metadata":{},"sourceType":"script"}